<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iOS MemoriesNativeModule – Implementation guide</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.55; max-width: 960px; margin: 0 auto; padding: 2rem; color: #222; }
    h1 { font-size: 1.6rem; border-bottom: 2px solid #333; padding-bottom: 0.5rem; }
    h2 { font-size: 1.25rem; margin-top: 2rem; color: #111; }
    h3 { font-size: 1.05rem; margin-top: 1.25rem; color: #333; }
    p { margin: 0.5rem 0; }
    table { border-collapse: collapse; width: 100%; margin: 0.75rem 0; font-size: 0.95rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem 0.65rem; text-align: left; vertical-align: top; }
    th { background: #f0f0f0; font-weight: 600; }
    code { background: #f0f0f0; padding: 0.12em 0.4em; border-radius: 3px; font-size: 0.9em; }
    pre { margin: 0.5rem 0; padding: 0.75rem; background: #263238; color: #eeffff; border-radius: 6px; overflow-x: auto; font-size: 0.85rem; }
    .param { margin: 0.35rem 0; }
    .param code { font-weight: 500; }
    ul { margin: 0.35rem 0; padding-left: 1.25rem; }
    li { margin: 0.2rem 0; }
    .intro { color: #444; margin-bottom: 1.25rem; }
    .bridge-note { background: #e3f2fd; padding: 0.5rem 0.75rem; border-radius: 6px; margin: 0.75rem 0; font-size: 0.95rem; }
    .required { background: #fff3e0; padding: 0.2em 0.5em; border-radius: 4px; font-size: 0.85rem; }
  </style>
</head>
<body>

<h1>iOS MemoriesNativeModule – Implementation guide</h1>

<p class="intro">This document describes what to add or implement in your <strong>existing</strong> iOS <code>MemoriesNativeModule</code> (Swift) and its Objective-C bridge (<code>MemoriesNativeModule.m</code>) so that the React Native app uses the same native APIs on both Android and iOS. It includes method names, parameter types, what React passes, and what to return.</p>
<h2>1. Methods already in your bridge (verify implementation)</h2>

<p>Your <code>MemoriesNativeModule.m</code> already declares these. Ensure the Swift implementation matches the following contract.</p>

<h3>1.1 showToast(message:isError:)</h3>
<table>
  <tr><th>Bridge (.m)</th><td><code>RCT_EXTERN_METHOD(showToast:(NSString *)message isError:(BOOL)isError)</code></td></tr>
  <tr><th>React call</th><td><code>MemoriesNativeModule.showToast(message, isError)</code></td></tr>
  <tr><th>Parameters</th><td>
    <div class="param"><code>message</code> (NSString) – Text to show. React passes a string (e.g. "Shared successfully", "Please select a plan").</div>
    <div class="param"><code>isError</code> (BOOL) – If true, show as error style (e.g. red); if false, success/info style.</div>
  </td></tr>
  <tr><th>Returns</th><td>Nothing (void). Fire-and-forget.</td></tr>
  <tr><th>iOS implementation</th><td>Show a short-lived banner or toast (e.g. custom view, or a third-party toast). Optionally use different appearance for <code>isError == true</code> vs <code>false</code>.</td></tr>
</table>

<h3>1.2 shareContent(content:title:)</h3>
<table>
  <tr><th>Bridge (.m)</th><td><code>RCT_EXTERN_METHOD(shareContent:(NSString *)content title:(NSString *)title)</code></td></tr>
  <tr><th>React call</th><td><code>MemoriesNativeModule.shareContent(shareMessage, 'Share Story')</code></td></tr>
  <tr><th>Parameters</th><td>
    <div class="param"><code>content</code> (NSString) – The share text (message body). May include referral text and deeplink URL.</div>
    <div class="param"><code>title</code> (NSString) – Share sheet title. React passes <code>"Share Story"</code>.</div>
  </td></tr>
  <tr><th>Returns</th><td>Nothing. Present <code>UIActivityViewController</code> with <code>content</code> (and optionally <code>title</code>).</td></tr>
</table>

<h3>1.3 shareContentAndActivateTrialOnReturn(content:title:programId:studentId:)</h3>
<table>
  <tr><th>Bridge (.m)</th><td>If React is to <code>await</code> this, the bridge must expose a Promise. Use: <code>RCT_EXTERN_METHOD(shareContentAndActivateTrialOnReturn:(NSString *)content title:(NSString *)title programId:(NSString *)programId studentId:(NSString *)studentId resolver:(RCTPromiseResolveBlock)resolve rejecter:(RCTPromiseRejectBlock)reject)</code>. If your current .m has no resolve/reject, add them and call <code>resolve(nil)</code> when the share flow completes (and optionally after activate_trial), and <code>reject(...)</code> on failure.</td></tr>
  <tr><th>React call</th><td><code>await MemoriesNativeModule.shareContentAndActivateTrialOnReturn(shareMessage, 'Share Story', programId, selectedStudentId)</code></td></tr>
  <tr><th>Parameters</th><td>
    <div class="param"><code>content</code> (NSString) – Same as shareContent.</div>
    <div class="param"><code>title</code> (NSString) – Same as shareContent.</div>
    <div class="param"><code>programId</code> (NSString) – Program ID for trial activation. May be empty string.</div>
    <div class="param"><code>studentId</code> (NSString) – Student ID for trial activation. May be empty string.</div>
  </td></tr>
  <tr><th>Returns</th><td>React awaits a Promise. Call <code>resolve(nil)</code> or <code>resolve(@(YES))</code> when share sheet is dismissed and (optionally) after triggering activate_trial on your backend. Call <code>reject(code, message, error)</code> on failure.</td></tr>
  <tr><th>iOS implementation</th><td>Present share sheet; in the completion handler (e.g. when user dismisses), call your backend to activate trial with <code>programId</code> and <code>studentId</code>, then call <code>resolve(nil)</code>. Reject if share fails or API fails.</td></tr>
</table>

<h2>2. Methods to add to the bridge and Swift</h2>

<p>These are called from React but are <strong>not</strong> in your current <code>MemoriesNativeModule.m</code>. Add the extern declaration and implement in Swift.</p>

<h3>2.1 getSchoolId</h3>
<table>
  <tr><th>Add to .m</th><td><code>RCT_EXTERN_METHOD(getSchoolId:(RCTPromiseResolveBlock)resolve rejecter:(RCTPromiseRejectBlock)reject)</code></td></tr>
  <tr><th>React call</th><td><code>await MemoriesNativeModule.getSchoolId()</code></td></tr>
  <tr><th>Parameters</th><td>None.</td></tr>
  <tr><th>Resolve with</th><td>NSString – current school ID (e.g. from your app context / user session). Pass empty string <code>@""</code> if not available.</td></tr>
  <tr><th>Reject</th><td>On fatal error (e.g. no session). Prefer resolving with <code>@""</code> if school is simply unknown.</td></tr>
</table>

<h3>2.2 goBackAndStartFromFirstSlide</h3>
<table>
  <tr><th>Add to .m</th><td><code>RCT_EXTERN_METHOD(goBackAndStartFromFirstSlide)</code></td></tr>
  <tr><th>React call</th><td><code>MemoriesNativeModule.goBackAndStartFromFirstSlide()</code></td></tr>
  <tr><th>Parameters</th><td>None.</td></tr>
  <tr><th>Returns</th><td>Void. Dismiss the React Native screen (e.g. the presented ReactNativeViewController), then tell the story view controller to reset to the first slide (e.g. set current page/slide index to 0).</td></tr>
</table>

<h3>2.3 openAlbumDetailScreen(id)</h3>
<table>
  <tr><th>Add to .m</th><td><code>RCT_EXTERN_METHOD(openAlbumDetailScreen:(NSString *)id)</code></td></tr>
  <tr><th>React call</th><td><code>MemoriesNativeModule.openAlbumDetailScreen(id)</code> – <code>id</code> is album.id or album._id (string or number from JS).</td></tr>
  <tr><th>Parameters</th><td><code>id</code> (NSString) – Album identifier. React may pass a number; the bridge will receive it as a string (e.g. <code>"123"</code>).</td></tr>
  <tr><th>Returns</th><td>Void. Open the album detail screen (same React Native screen with album context, or a native screen) for this album.</td></tr>
</table>

<h3>2.4 downloadAlbumImages(urls)</h3>
<table>
  <tr><th>Add to .m</th><td><code>RCT_EXTERN_METHOD(downloadAlbumImages:(NSArray *)urls)</code> – or if you prefer stringified JSON: <code>RCT_EXTERN_METHOD(downloadAlbumImages:(NSString *)urlsJson)</code> and parse in Swift.</td></tr>
  <tr><th>React call</th><td><code>MemoriesNativeModule.downloadAlbumImages(urls)</code> – <code>urls</code> is a JS array of URL strings, e.g. <code>["https://...", "https://..."]</code>.</td></tr>
  <tr><th>Parameters</th><td><code>urls</code> – If using NSArray: array of NSString (image URLs). If using NSString: JSON array string, e.g. <code>["https://...","https://..."]</code>. Parse in Swift with <code>JSONSerialization</code>.</td></tr>
  <tr><th>Returns</th><td>Void. Download each URL (e.g. URLSession) and save to Photos or Files. Optionally show a native progress or “Saved” toast.</td></tr>
</table>

<h3>2.5 shareAlbumImages(items, title)</h3>
<table>
  <tr><th>Add to .m</th><td>If bridge supports array/dict: <code>RCT_EXTERN_METHOD(shareAlbumImages:(NSArray *)items title:(NSString *)title)</code>. Else pass stringified JSON: <code>RCT_EXTERN_METHOD(shareAlbumImages:(NSString *)itemsJson title:(NSString *)title)</code>.</td></tr>
  <tr><th>React call</th><td><code>MemoriesNativeModule.shareAlbumImages(items, album?.title ?? 'Album')</code>. <code>items</code> is array of <code>{ url: string, isVideo: boolean }</code>.</td></tr>
  <tr><th>Parameters</th><td>
    <div class="param"><code>items</code> – Array of objects with <code>url</code> (string) and <code>isVideo</code> (boolean). If using NSString, React can pass <code>JSON.stringify(items)</code> and you parse in Swift.</div>
    <div class="param"><code>title</code> (NSString) – Album title for the share sheet.</div>
  </td></tr>
  <tr><th>Returns</th><td>Void. Build <code>UIActivityViewController</code> with the image URLs (and optionally video URLs). Use <code>isVideo</code> to decide whether to share as image or video if needed.</td></tr>
</table>

<h3>2.6 openVideoPlayer(url)</h3>
<table>
  <tr><th>Add to .m</th><td><code>RCT_EXTERN_METHOD(openVideoPlayer:(NSString *)url)</code></td></tr>
  <tr><th>React call</th><td><code>MemoriesNativeModule.openVideoPlayer(url)</code> – single video URL string.</td></tr>
  <tr><th>Parameters</th><td><code>url</code> (NSString) – Video URL (or thumbnail URL if that’s what React passes).</td></tr>
  <tr><th>Returns</th><td>Void. Present full-screen AVPlayer (or AVPlayerViewController) with this URL.</td></tr>
</table>

<h3>2.7 openAlbumImageZoom(albumJson, index)</h3>
<table>
  <tr><th>Add to .m</th><td><code>RCT_EXTERN_METHOD(openAlbumImageZoom:(NSString *)albumJson index:(NSInteger)index)</code></td></tr>
  <tr><th>React call</th><td><code>MemoriesNativeModule.openAlbumImageZoom(JSON.stringify(album), index)</code>. <code>album</code> is the full album object (images array, titles, etc.).</td></tr>
  <tr><th>Parameters</th><td>
    <div class="param"><code>albumJson</code> (NSString) – JSON string of the album object. Parse in Swift with <code>JSONSerialization.jsonObject(with:data)</code>. Structure typically includes an array of image items (urls, captions, etc.).</div>
    <div class="param"><code>index</code> (NSInteger) – Zero-based index of the image to show first. Use for initial page in a page view controller or gallery.</div>
  </td></tr>
  <tr><th>Returns</th><td>Void. Present a full-screen image viewer (native or RN) that can swipe through album images starting at <code>index</code>.</td></tr>
</table>

<h3>2.8 shareAlbum(title, publicUrl)</h3>
<table>
  <tr><th>Add to .m</th><td><code>RCT_EXTERN_METHOD(shareAlbum:(NSString *)title publicUrl:(NSString *)publicUrl)</code></td></tr>
  <tr><th>React call</th><td><code>MemoriesNativeModule.shareAlbum(title, publicUrl)</code></td></tr>
  <tr><th>Parameters</th><td>
    <div class="param"><code>title</code> (NSString) – Album title (e.g. "Summer 2024").</div>
    <div class="param"><code>publicUrl</code> (NSString) – Public link to the album (e.g. https://...).</div>
  </td></tr>
  <tr><th>Returns</th><td>Void. Present <code>UIActivityViewController</code> with <code>publicUrl</code> and optionally <code>title</code> as the message or subject.</td></tr>
</table>

<h2>3. Summary – what to add in MemoriesNativeModule.m</h2>

<pre>// Add these to your existing RCT_EXTERN_MODULE block:

RCT_EXTERN_METHOD(getSchoolId:(RCTPromiseResolveBlock)resolve rejecter:(RCTPromiseRejectBlock)reject)
RCT_EXTERN_METHOD(goBackAndStartFromFirstSlide)
RCT_EXTERN_METHOD(openAlbumDetailScreen:(NSString *)id)
RCT_EXTERN_METHOD(downloadAlbumImages:(NSArray *)urls)
RCT_EXTERN_METHOD(shareAlbumImages:(NSArray *)items title:(NSString *)title)
RCT_EXTERN_METHOD(openVideoPlayer:(NSString *)url)
RCT_EXTERN_METHOD(openAlbumImageZoom:(NSString *)albumJson index:(NSInteger)index)
RCT_EXTERN_METHOD(shareAlbum:(NSString *)title publicUrl:(NSString *)publicUrl)</pre>

<p>If your React Native bridge version does not support passing <code>NSArray</code> from JS, use string parameters and parse in Swift:</p>
<ul>
  <li><code>downloadAlbumImages:(NSString *)urlsJson</code> – parse as JSON array of strings.</li>
  <li><code>shareAlbumImages:(NSString *)itemsJson title:(NSString *)title</code> – parse <code>itemsJson</code> as JSON array of <code>{ url, isVideo }</code>.</li>
</ul>

<h2>4. Parameter types from React (reference)</h2>

<table>
  <thead>
    <tr><th>React passes</th><th>Objective-C / Swift receives</th></tr>
  </thead>
  <tbody>
    <tr><td><code>string</code></td><td><code>NSString *</code></td></tr>
    <tr><td><code>number</code></td><td><code>NSNumber *</code> or (with RCT_EXTERN_METHOD) often coerced to NSInteger where applicable</td></tr>
    <tr><td><code>boolean</code></td><td><code>BOOL</code></td></tr>
    <tr><td><code>array</code></td><td><code>NSArray *</code> (if supported by your RN version)</td></tr>
    <tr><td><code>object</code></td><td><code>NSDictionary *</code></td></tr>
    <tr><td>Promise resolve</td><td><code>RCTPromiseResolveBlock</code> – call with a single object (e.g. NSString, NSNumber). React receives it as the resolved value.</td></tr>
    <tr><td>Promise reject</td><td><code>RCTPromiseRejectBlock</code> – call with (errorCode, message, error). Use standard codes like <code>"E_FAILED"</code>.</td></tr>
  </tbody>
</table>

<h2>5. React code changes already done</h2>

<p>The following React files were updated so that native module methods are used on <strong>both</strong> Android and iOS when the module exists (no <code>Platform.OS === 'android'</code> guard for these calls):</p>
<ul>
  <li><code>MemoriesScreen.js</code> – share (<code>shareContent</code>), showToast</li>
  <li><code>PostSevenStoriesScreen.js</code> – showToast, share (<code>shareContentAndActivateTrialOnReturn</code>, <code>shareContent</code>), plus <code>Alert</code> import for iOS toast fallback</li>
  <li><code>CapturedBedtimeMemoriesScreen.js</code> – showToast</li>
  <li><code>rn-app/MemoriesScreen.js</code>, <code>rn-app/PostSevenStoriesScreen.js</code>, <code>rn-app/CapturedBedtimeMemoriesScreen.js</code> – same logic</li>
</ul>

</body>
</html>
